#!/bin/bash

# Configuration
PROJECT_NAME=$(basename "$PWD" | tr '[:upper:]' '[:lower:]' | tr '_' '-')
SERVER="user@yourserver.com"
TOOL_DIR="$HOME/$PROJECT_NAME"
LOCK_FILE="$TOOL_DIR/deploy.lock"
RELEASES_DIR="$TOOL_DIR/releases"
DOCKER_COMPOSE_FILE="./compose.yaml"

# First-time setup on the server
initial_server_setup() {
  echo "Setting up server for the first deployment..."
  ssh $SERVER "mkdir -p $TOOL_DIR $RELEASES_DIR"
  ssh $SERVER "sudo apt-get update && sudo apt-get install -y docker docker-compose"
  scp $DOCKER_COMPOSE_FILE $SERVER:$TOOL_DIR/
  echo "Server setup complete."
}

# Acquire deployment lock with retry logic
acquire_lock() {
  echo "Acquiring deployment lock..."
  local attempts=0
  while ssh $SERVER "[ -e $LOCK_FILE ]"; do
    if [ $attempts -ge 3 ]; then
      echo "Failed to acquire lock after 3 attempts. Exiting."
      exit 1
    fi
    echo "Lock file present, retrying in 30 seconds..."
    sleep 30
    ((attempts++))
  done
  ssh $SERVER "touch $LOCK_FILE"
}

# Release deployment lock
release_lock() {
  ssh $SERVER "rm -f $LOCK_FILE"
}

# Main deployment flow
deploy() {
  # Check if it's the first deployment by looking for the lock file
  if ! ssh $SERVER "[ -e $LOCK_FILE ]"; then
    initial_server_setup
  fi

  # Begin deployment steps
  echo "Starting deployment..."
  # Additional deployment logic goes here

  # Cleanup
  release_lock
}

# Execute deployment
acquire_lock
trap release_lock EXIT
deploy